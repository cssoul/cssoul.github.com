(function(seajs){var Module=seajs.Module;var FETCHING=Module.STATUS.FETCHING;var data=seajs.data;var comboHash=data.comboHash={};var comboSyntax=["??",","];var comboMaxLength=2E3;var comboExcludes;seajs.on("load",setComboHash);seajs.on("fetch",setRequestUri);function setComboHash(uris){var len=uris.length;if(len<2)return;data.comboSyntax&&(comboSyntax=data.comboSyntax);data.comboMaxLength&&(comboMaxLength=data.comboMaxLength);comboExcludes=data.comboExcludes;var needComboUris=[];for(var i=0;i<len;i++){var uri=
uris[i];if(comboHash[uri])continue;var mod=Module.get(uri);if(mod.status<FETCHING&&!isExcluded(uri)&&!isComboUri(uri))needComboUris.push(uri)}if(needComboUris.length>1)paths2hash(uris2paths(needComboUris))}function setRequestUri(data){data.requestUri=comboHash[data.uri]||data.uri}function uris2paths(uris){return meta2paths(uris2meta(uris))}function uris2meta(uris){var meta={__KEYS:[]};for(var i=0,len=uris.length;i<len;i++){var parts=uris[i].replace("://","__").split("/");var m=meta;for(var j=0,l=
parts.length;j<l;j++){var part=parts[j];if(!m[part]){m[part]={__KEYS:[]};m.__KEYS.push(part)}m=m[part]}}return meta}function meta2paths(meta){var paths=[];var __KEYS=meta.__KEYS;for(var i=0,len=__KEYS.length;i<len;i++){var part=__KEYS[i];var root=part;var m=meta[part];var KEYS=m.__KEYS;while(KEYS.length===1){root+="/"+KEYS[0];m=m[KEYS[0]];KEYS=m.__KEYS}if(KEYS.length)paths.push([root.replace("__","://"),meta2arr(m)])}return paths}function meta2arr(meta){var arr=[];var __KEYS=meta.__KEYS;for(var i=
0,len=__KEYS.length;i<len;i++){var key=__KEYS[i];var r=meta2arr(meta[key]);var m=r.length;if(m)for(var j=0;j<m;j++)arr.push(key+"/"+r[j]);else arr.push(key)}return arr}function paths2hash(paths){for(var i=0,len=paths.length;i<len;i++){var path=paths[i];var root=path[0]+"/";var group=files2group(path[1]);for(var j=0,m=group.length;j<m;j++)setHash(root,group[j])}return comboHash}function setHash(root,files){var comboPath=root+comboSyntax[0]+files.join(comboSyntax[1]);var exceedMax=comboPath.length>
comboMaxLength;if(files.length>1&&exceedMax){var parts=splitFiles(files,comboMaxLength-(root+comboSyntax[0]).length);setHash(root,parts[0]);setHash(root,parts[1])}else{if(exceedMax)throw new Error("The combo url is too long: "+comboPath);for(var i=0,len=files.length;i<len;i++)comboHash[root+files[i]]=comboPath}}function splitFiles(files,filesMaxLength){var sep=comboSyntax[1];var s=files[0];for(var i=1,len=files.length;i<len;i++){s+=sep+files[i];if(s.length>filesMaxLength)return[files.splice(0,i),
files]}}function files2group(files){var group=[];var hash={};for(var i=0,len=files.length;i<len;i++){var file=files[i];var ext=getExt(file);if(ext)(hash[ext]||(hash[ext]=[])).push(file)}for(var k in hash)if(hash.hasOwnProperty(k))group.push(hash[k]);return group}function getExt(file){var p=file.lastIndexOf(".");return p>=0?file.substring(p):""}function isExcluded(uri){if(comboExcludes)return comboExcludes.test?comboExcludes.test(uri):comboExcludes(uri)}function isComboUri(uri){var comboSyntax=data.comboSyntax||
["??",","];var s1=comboSyntax[0];var s2=comboSyntax[1];return s1&&uri.indexOf(s1)>0||s2&&uri.indexOf(s2)>0}if(data.test){var test=seajs.test||(seajs.test={});test.uris2paths=uris2paths;test.paths2hash=paths2hash}define("seajs-combo",[],{})})(seajs);